<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 å­—å¹•ä¸‹è¼‰å™¨ v5.2 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .log-box {
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-box::-webkit-scrollbar { width: 8px; }
        .log-box::-webkit-scrollbar-track { background: #1f2937; }
        .log-box::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }

        .highlight-next-step {
            animation: pulse-border 2s infinite;
            background-color: #eff6ff; 
        }
        @keyframes pulse-border {
            0% { border-color: #e5e7eb; box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            50% { border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4); }
            100% { border-color: #e5e7eb; box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
        }
        
        .code-block {
            background-color: #012456; /* PowerShell Blue */
            color: #ffffff;
            font-family: Consolas, 'Courier New', monospace;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            white-space: pre;
            font-size: 0.8rem;
            border: 2px solid #3b82f6;
        }
        
        /* é‡å°å³å´èªªæ˜çš„æ¨£å¼å„ªåŒ– */
        .instruction-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            margin-bottom: 1rem;
        }
        .instruction-title {
            font-weight: 700;
            color: #1e40af;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .instruction-step {
            display: flex;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #4b5563;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        .step-num {
            background-color: #dbeafe;
            color: #1e40af;
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            font-weight: bold;
            flex-shrink: 0;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col font-sans text-slate-900">

    <!-- Main Content Wrapper -->
    <div class="flex-grow flex items-start justify-center p-4 md:py-10">
        <div class="bg-white w-full max-w-7xl rounded-xl shadow-xl overflow-hidden flex flex-col md:flex-row">
            
            <!-- å·¦å´ï¼šä¸»è¦æ“ä½œå€ -->
            <div class="w-full md:w-7/12 p-6 md:p-8 space-y-5 flex flex-col">
                <div class="border-b pb-4 mb-2">
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <span class="text-3xl">ğŸ¬</span> M3U8 å­—å¹•ä¸‹è¼‰å™¨ <span class="text-xs bg-teal-600 text-white px-2 py-1 rounded-full">v5.2 Pro</span>
                    </h1>
                    <p class="text-gray-500 text-sm mt-1">æ”¯æ´å‹•æ…‹å¯†é‘°æ··åˆæŠ€è¡“ + User-Agent å½è£</p>
                </div>

                <div class="space-y-4">
                    <!-- æª”å -->
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <label class="block text-gray-700 font-bold mb-1 text-sm">æª”æ¡ˆåç¨± (å»ºè­°å¡«å¯«)</label>
                        <div class="flex gap-2">
                            <input type="text" id="filenameInput" placeholder="ä¾‹å¦‚ï¼šCH1_èª²ç¨‹ä»‹ç´¹" class="flex-1 px-3 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                            <button onclick="pasteTitle()" class="whitespace-nowrap bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 px-3 py-2 rounded text-xs font-bold transition">ğŸ“‹ è²¼ä¸Š</button>
                        </div>
                    </div>

                    <!-- Step 1: Base URL -->
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 transition-all duration-300" id="step1Box">
                        <label class="block text-blue-900 font-bold mb-2 text-sm flex items-center gap-2">
                            <span class="bg-blue-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">1</span>
                            ç¬¬ä¸€æ­¥ï¼šè²¼ä¸ŠåŸå§‹é€£çµ (Request URL)
                        </label>
                        <input type="text" id="baseUrlInput" placeholder="Network > Headers > Request URL (å¦‚æœæ˜¯ç›¸å°è·¯å¾‘å‰‡å¿…å¡«)" class="w-full px-3 py-2 rounded border border-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs text-gray-600 font-mono shadow-sm">
                        <div id="baseUrlMsg" class="text-[10px] mt-1 h-4 transition-all"><span class="text-blue-400">* è‹¥å…§å®¹åŒ…å«å®Œæ•´ç¶²å€å¯ç•¥éã€‚</span></div>
                    </div>

                    <!-- Step 2: User-Agent (Fixed) -->
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 transition-all duration-300" id="step2Box">
                        <label class="block text-indigo-900 font-bold mb-2 text-sm flex items-center gap-2 justify-between">
                            <div class="flex items-center gap-2">
                                <span class="bg-indigo-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">2</span>
                                <span>ç¬¬äºŒæ­¥ï¼šUser-Agent (ç€è¦½å™¨æŒ‡ç´‹)</span>
                            </div>
                            <span class="text-[10px] text-green-600 bg-white px-2 py-0.5 rounded border border-green-200 font-bold">å·²é è¨­å®Œæˆ</span>
                        </label>
                        <input type="text" id="uaInput" value="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36" placeholder="User-Agent å­—ä¸²" class="w-full px-3 py-2 rounded border border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-xs text-gray-600 font-mono shadow-sm">
                        <div class="text-[10px] mt-1 text-indigo-400">* å·²é è¨­ç‚º Chrome 144 ç‰ˆæœ¬ã€‚é™¤éå¤±æ•ˆï¼Œå¦å‰‡ç„¡éœ€æ›´å‹•ã€‚</div>
                    </div>

                    <!-- Step 3: Content -->
                    <div class="p-4 rounded-lg border border-gray-200 transition-all duration-300" id="step3Box">
                        <label class="block text-gray-700 font-bold mb-2 text-sm flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="bg-gray-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs" id="step3Badge">3</span>
                                <span>ç¬¬ä¸‰æ­¥ï¼šè²¼ä¸Šå­—å¹•å…§å®¹</span>
                            </div>
                            <span class="text-xs font-normal text-gray-400">Response / Preview</span>
                        </label>
                        <textarea id="contentInput" rows="5" placeholder="è«‹è²¼ä¸Šå­—å¹•åˆ—è¡¨å…§å®¹..." class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition text-xs font-mono bg-gray-50"></textarea>
                        <div class="flex justify-between items-center mt-1">
                            <p class="text-xs text-gray-500 font-medium" id="linkCountText">ç­‰å¾…è¼¸å…¥...</p>
                            <button onclick="clearInput()" class="text-xs text-red-400 hover:text-red-600 font-bold px-2 py-1 rounded hover:bg-red-50 border border-transparent hover:border-red-200 transition">ğŸ—‘ï¸ å…¨éƒ¨æ¸…ç©ºé‡ä¾†</button>
                        </div>
                    </div>

                    <!-- ä¸‹è¼‰æŒ‰éˆ• -->
                    <button id="startBtn" onclick="processInputAndStart()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 group">
                        <span class="group-hover:scale-110 transition-transform">ğŸš€</span> è§£æä¸¦ä¸‹è¼‰
                    </button>
                </div>

                <!-- é€²åº¦æ¢ -->
                <div id="progressContainer" class="hidden space-y-1 pt-2">
                    <div class="flex justify-between text-xs font-medium text-gray-600">
                        <span id="statusText">æº–å‚™ä¸­...</span>
                        <span id="counterText">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                        <div id="progressBar" class="bg-blue-500 h-2 rounded-full w-0 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Log å€ (åŠ é«˜ç‰ˆ) -->
                <div class="bg-slate-900 text-green-400 p-3 rounded-lg h-96 overflow-y-auto text-xs log-box shadow-inner border border-slate-700 flex-grow" id="logBox">
                    <span class="text-gray-500">ç³»çµ±æº–å‚™å°±ç·’...</span>
                </div>
            </div>

            <!-- å³å´ï¼šæ•™å­¸èˆ‡è³‡è¨Šå€ -->
            <div class="w-full md:w-5/12 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-4">
                
                <!-- æ•‘æ´æ¨¡å¼å€å¡Š (å‹•æ…‹é¡¯ç¤º) -->
                <div id="rescueContainer" class="hidden bg-amber-50 border-2 border-amber-400 rounded-xl p-4 shadow-lg animate-pulse ring-4 ring-amber-100 mb-2">
                    <div class="flex items-center gap-2 border-b border-amber-200 pb-2 mb-2">
                        <span class="text-2xl">ğŸ›¡ï¸</span>
                        <div>
                            <h3 class="font-bold text-amber-900">å®‰å…¨é˜»æ“‹åµæ¸¬</h3>
                            <p class="text-[10px] text-amber-700">ç€è¦½å™¨ç„¡æ³•ç›´æ¥ä¸‹è¼‰ï¼Œè«‹ä½¿ç”¨ä¸‹æ–¹æŒ‡ä»¤ (ç„¡ç—›éœé»˜ç‰ˆ)</p>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="bg-white p-3 rounded border border-amber-200 text-xs text-amber-800">
                            <strong class="block mb-1">ğŸ“ ç°¡å–® 3 æ­¥é©Ÿï¼š</strong>
                            1. é»æ“Šã€Œè¤‡è£½æŒ‡ä»¤ã€ã€‚<br>
                            2. é–‹å•Ÿè—è‰²çš„ PowerShellã€‚<br>
                            3. è²¼ä¸ŠæŒ‡ä»¤ä¸¦åŸ·è¡Œã€‚<br>
                            <span class="text-green-600 font-bold block mt-1">âœ… æª”æ¡ˆå°‡è‡ªå‹•å­˜å…¥æ‚¨çš„ä¸‹è¼‰è³‡æ–™å¤¾ã€‚</span>
                        </div>

                        <div class="relative">
                            <textarea id="rescueScript" class="code-block w-full h-48 text-[10px]" readonly onclick="this.select()"></textarea>
                            <button onclick="copyRescueScript()" class="absolute top-2 right-2 bg-white text-amber-800 text-xs font-bold px-3 py-1 rounded shadow hover:bg-gray-100 border border-amber-200">
                                è¤‡è£½æŒ‡ä»¤
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æ•´åˆèªªæ˜å€ -->
                <div class="space-y-4">
                    
                    <!-- æ›¸ç±¤ç¥å™¨ -->
                    <div class="instruction-card border-purple-200 bg-purple-50/50">
                        <h3 class="font-bold text-purple-800 text-sm mb-2 flex items-center gap-2">
                            âš¡ å¿«é€ŸæŠ“æª”åç¥å™¨
                        </h3>
                        <p class="text-xs text-gray-500 mb-2">
                            å°‡ä¸‹æ–¹æŒ‰éˆ•<b>æ‹–æ›³</b>åˆ°æ‚¨çš„ç€è¦½å™¨ã€Œæ›¸ç±¤åˆ—ã€ã€‚<br>
                            ä»¥å¾Œåœ¨å½±ç‰‡é é¢é»ä¸€ä¸‹è©²æ›¸ç±¤ï¼Œå°±æœƒè‡ªå‹•è¤‡è£½ç¶²é æ¨™é¡Œï¼
                        </p>
                        <div class="flex justify-center mt-2">
                            <a 
                                href="javascript:(function(){var t=document.title.replace(/[\/\\:*?&quot;<>|]/g,'_');navigator.clipboard.writeText(t).then(function(){alert('å·²è¤‡è£½æ¨™é¡Œï¼š\n'+t);}).catch(function(){prompt('è«‹æ‰‹å‹•è¤‡è£½ï¼š',t);});})();"
                                class="bg-white hover:bg-purple-100 text-purple-700 text-xs font-bold py-2 px-4 rounded-full border border-purple-300 cursor-move flex items-center gap-1 transition select-none shadow-sm"
                                title="æ‹–æ›³æˆ‘åˆ°æ›¸ç±¤åˆ—"
                                onclick="alert('è«‹å°‡æ­¤æŒ‰éˆ•ã€Œæ‹–æ›³ã€åˆ°ç€è¦½å™¨çš„æ›¸ç±¤åˆ—ä¸Šï¼Œè€Œä¸æ˜¯ç›´æ¥é»æ“Šå–”ï¼');return false;"
                            >
                                <span>ğŸ”–</span> è¤‡è£½æœ¬é æ¨™é¡Œ (æ‹–æ›³æˆ‘)
                            </a>
                        </div>
                    </div>

                    <!-- ç°¡æ˜“æ¨¡å¼èªªæ˜ -->
                    <div class="instruction-card border-green-200 bg-green-50/50">
                        <h3 class="font-bold text-green-800 text-sm mb-2 flex items-center gap-2">
                            ğŸš€ ç°¡æ˜“æ¨¡å¼ (å·²é è¨­ UA)
                        </h3>
                        <p class="text-xs text-gray-600 leading-relaxed">
                            æœ¬ç‰ˆæœ¬å·²ç‚ºæ‚¨é è¨­å¥½ User-Agentã€‚è‹¥ç¶²ç«™ç„¡ç‰¹æ®ŠåŠ å¯†ï¼Œæ‚¨åªéœ€å¡«å¯« <strong>ã€Œ3. å­—å¹•å…§å®¹ã€</strong> å³å¯ä¸€éµä¸‹è¼‰ã€‚
                        </p>
                    </div>

                    <!-- å¦‚ä½•æ‰¾åˆ° Request URL -->
                    <div class="instruction-card">
                        <h3 class="instruction-title">
                            <span class="text-xl">ğŸ¯</span> å¦‚ä½•æ‰¾åˆ°æ­£ç¢ºçš„ Request URL ?
                        </h3>
                        <div class="instruction-step">
                            <span class="step-num">1</span>
                            <p>é»æ“Š Network åˆ—è¡¨ä¸­çš„å­—å¹•æª” (é‚£å€‹å…§å®¹æœ‰ä¸€å † .vtt çš„æª”æ¡ˆ)ã€‚</p>
                        </div>
                        <div class="instruction-step">
                            <span class="step-num">2</span>
                            <p>çœ‹å³å´é¢æ¿çš„ä¸Šæ–¹åˆ†é ï¼Œé»æ“Š <strong>[Headers]</strong>ã€‚</p>
                        </div>
                        <div class="instruction-step">
                            <span class="step-num">3</span>
                            <p>æ‰¾åˆ° <strong>Request URL</strong>ã€‚è¤‡è£½è©²é€£çµï¼ˆå¦‚æœæ˜¯ç›¸å°è·¯å¾‘æ™‚ï¼Œé€™æ­¥å¿…å¡«ï¼‰ã€‚</p>
                        </div>
                    </div>

                    <!-- æ“ä½œæµç¨‹ / å¦‚ä½•æ‰¾å…§å®¹ -->
                    <div class="instruction-card">
                        <h3 class="instruction-title">
                            <span class="text-xl">ğŸ“„</span> å¦‚ä½•æ‰¾åˆ°å­—å¹•å…§å®¹ ?
                        </h3>
                        <div class="instruction-step">
                            <span class="step-num">1</span>
                            <p>åœ¨ Network æœå°‹ <code>m3u8</code> æˆ– <code>vtt</code>ã€‚</p>
                        </div>
                        <div class="instruction-step">
                            <span class="step-num">2</span>
                            <p>æ‰¾åˆ° Response è£¡æœ‰ä¸€å † .vtt æª”åçš„æª”æ¡ˆã€‚</p>
                        </div>
                        <div class="instruction-step">
                            <span class="step-num">3</span>
                            <p>è¤‡è£½è©²å…§å®¹è²¼åˆ°å·¦å´çš„ã€Œ3. å­—å¹•å…§å®¹ã€å¾Œé»æ“Šä¸‹è¼‰ã€‚</p>
                        </div>
                    </div>

                    <!-- æŠ€è¡“åŸç† -->
                    <div class="bg-amber-50 p-3 rounded-lg border border-amber-100 text-[10px] text-amber-800 leading-relaxed">
                        <strong class="block mb-1">ğŸ› ï¸ é—œæ–¼ User-Agent çš„ä½œç”¨</strong>
                        User-Agent æ˜¯å‘Šè¨´ç¶²ç«™ã€Œä½ æ˜¯èª°ã€ã€‚æŸäº›ç¶²ç«™ (å¦‚ Hotmart) æœƒæª¢æŸ¥é€™å€‹æŒ‡ç´‹ä¾†é˜²æ­¢éç€è¦½å™¨çš„ä¸‹è¼‰è¡Œç‚ºã€‚æœ¬å·¥å…·å·²é è¨­ç‚ºä¸»æµ Chrome æŒ‡ç´‹ä»¥æå‡æˆåŠŸç‡ã€‚
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 mt-auto py-6">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-slate-500 text-sm">Â© <span id="year"></span> <a href="https://huobest.com/" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">éœå®¶ç§å¡¾</a>. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        const logBox = document.getElementById('logBox');
        const contentInput = document.getElementById('contentInput');
        const baseUrlInput = document.getElementById('baseUrlInput');
        const baseUrlMsg = document.getElementById('baseUrlMsg');
        const uaInput = document.getElementById('uaInput');
        const filenameInput = document.getElementById('filenameInput');
        const linkCountText = document.getElementById('linkCountText');
        const startBtn = document.getElementById('startBtn');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const statusText = document.getElementById('statusText');
        const counterText = document.getElementById('counterText');
        
        const step2Box = document.getElementById('step2Box');
        const step3Box = document.getElementById('step3Box');
        const step3Badge = document.getElementById('step3Badge');
        
        const rescueContainer = document.getElementById('rescueContainer');
        const rescueScript = document.getElementById('rescueScript');

        let globalUrls = []; 

        async function pasteTitle() {
            try {
                const text = await navigator.clipboard.readText();
                if (text) filenameInput.value = text.replace(/[\\/:*?"<>|]/g, '_');
            } catch (err) { alert('è«‹æ‰‹å‹•è²¼ä¸Š'); }
        }

        baseUrlInput.addEventListener('input', () => {
            const val = baseUrlInput.value.trim();
            if (val.length === 0) {
                 baseUrlMsg.innerHTML = '<span class="text-blue-400">* è‹¥å…§å®¹åŒ…å«å®Œæ•´ç¶²å€å¯ç•¥éã€‚</span>';
                 step2Box.classList.remove('highlight-next-step');
            } else if (!val.startsWith('http')) {
                baseUrlMsg.innerHTML = '<span class="text-orange-500">âš ï¸ ç¶²å€å¿…é ˆä»¥ http é–‹é ­ã€‚</span>';
                step2Box.classList.remove('highlight-next-step');
            } else {
                baseUrlMsg.innerHTML = '<span class="text-green-600 font-bold">âœ… æ ¼å¼æ­£ç¢ºã€‚</span>';
                // å¦‚æœ Step 1 å¥½äº†ï¼ŒStep 2 åˆæ˜¯é è¨­å¥½çš„ï¼Œç›´æ¥å°å‘ Step 3
                step3Box.classList.add('highlight-next-step');
            }
            contentInput.dispatchEvent(new Event('input'));
        });

        uaInput.addEventListener('input', () => {
            const val = uaInput.value.trim();
            if(val) {
                step2Box.classList.remove('highlight-next-step');
                step3Box.classList.add('highlight-next-step');
                contentInput.focus();
            }
        });

        contentInput.addEventListener('input', () => {
            const text = contentInput.value.trim();
            if(text.length > 0) step3Box.classList.remove('highlight-next-step');
            if (!text) { linkCountText.innerText = 'ç­‰å¾…è¼¸å…¥...'; return; }

            const result = parseUrls(text, baseUrlInput.value.trim());
            globalUrls = result.urls; 

            if (result.urls.length > 0) {
                let typeInfo = result.hasRelative ? 'ç›¸å°è·¯å¾‘' : 'çµ•å°è·¯å¾‘';
                if (result.hasRelative && !result.validBase) {
                    typeInfo += ' <span class="text-red-500 font-bold">(ç¼ºå°‘æ­¥é©Ÿ 1 ç¶²å€!)</span>';
                }
                linkCountText.innerHTML = `<span class="text-purple-600 font-bold">ğŸ“„ ${result.urls.length} å€‹ç‰‡æ®µ</span> (${typeInfo})`;
            } else {
                linkCountText.innerHTML = '<span class="text-red-500">âš ï¸ æ‰¾ä¸åˆ° .vtt / .webvtt</span>';
            }
        });

        function clearInput() {
            filenameInput.value = '';
            contentInput.value = '';
            baseUrlInput.value = ''; 
            // æ¸…ç©ºæ™‚ä¸é‡è¨­é è¨­ UA
            baseUrlMsg.innerHTML = '<span class="text-blue-400">* è‹¥å…§å®¹åŒ…å«å®Œæ•´ç¶²å€å¯ç•¥éã€‚</span>';
            linkCountText.innerText = 'ç­‰å¾…è¼¸å…¥...';
            step2Box.classList.remove('highlight-next-step');
            step3Box.classList.remove('highlight-next-step');
            rescueContainer.classList.add('hidden'); 
        }

        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            let color = 'text-green-400';
            if (type === 'error') color = 'text-red-400';
            if (type === 'warn') color = 'text-yellow-400';
            if(logBox.innerHTML.includes('ç³»çµ±æº–å‚™å°±ç·’')) logBox.innerHTML = '';
            logBox.innerHTML += `<div class="${color} mb-1 pl-1 border-l-2 ${type==='error'?'border-red-500':(type==='warn'?'border-yellow-500':'border-green-500')}"><span class="opacity-50 select-none">[${time}]</span> ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        function parseUrls(content, baseUrl) {
            const urls = [];
            let hasRelative = false;
            let validBase = false;
            let baseObj = null;

            if (baseUrl && baseUrl.startsWith('http') && !baseUrl.includes('.key')) {
                try { baseObj = new URL(baseUrl); validBase = true; } catch(e) {}
            }

            const absoluteRegex = /https?:\/\/[^\s"']+\.(?:vtt|webvtt)[^\s"']*/gi;
            const absoluteMatches = content.match(absoluteRegex) || [];
            
            if (absoluteMatches.length > 0) {
                return { urls: absoluteMatches, hasRelative: false, validBase: true };
            }

            const lines = content.split(/\r?\n/);
            const lineRegex = /^(?!#).*\.(?:vtt|webvtt)(?:$|\?)/i;

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                if (lineRegex.test(line)) {
                    if (line.startsWith('http')) {
                        urls.push(line);
                    } else {
                        hasRelative = true;
                        if (baseObj) {
                            try { urls.push(new URL(line, baseObj).href); } catch (e) {}
                        } else {
                            urls.push(line); 
                        }
                    }
                }
            }
            return { urls, hasRelative, validBase };
        }

        async function processInputAndStart() {
            const content = contentInput.value.trim();
            const baseUrl = baseUrlInput.value.trim();

            if (!content) { alert("è«‹è‡³å°‘å®Œæˆç¬¬ä¸‰æ­¥ (è²¼ä¸Šå…§å®¹)ï¼"); return; }
            rescueContainer.classList.add('hidden'); 

            logBox.innerHTML = '';
            startBtn.disabled = true;
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressBar.classList.remove('bg-green-500', 'bg-red-500');
            progressBar.classList.add('bg-blue-500');

            const result = parseUrls(content, baseUrl);
            globalUrls = result.urls;

            if (result.urls.length === 0) {
                log("âŒ æ‰¾ä¸åˆ° .vtt é€£çµã€‚", 'error');
                startBtn.disabled = false;
                return;
            }

            if (result.hasRelative && !result.validBase) {
                log("âŒ éŒ¯èª¤ï¼šé€™æ˜¯ç›¸å°è·¯å¾‘ï¼Œè«‹å¡«å¯«ã€Œç¬¬ä¸€æ­¥ã€çš„ç¶²å€ã€‚", 'error');
                alert("ç¼ºå°‘æ­¥é©Ÿ 1 çš„ç¶²å€ï¼");
                startBtn.disabled = false;
                return;
            }
            
            log(`ğŸš€ ç™¼ç¾ ${result.urls.length} å€‹ç‰‡æ®µï¼Œå˜—è©¦ä¸‹è¼‰...`);
            
            const success = await startBatchDownload(result.urls);
            
            if (!success) {
                generateRescueScript(result.urls);
            }
            startBtn.disabled = false;
        }

        async function startBatchDownload(urls) {
            let finalContent = "";
            let successCount = 0;
            let failCount = 0;

            const testLimit = Math.min(urls.length, 3);
            let earlyFailure = false;

            for (let i = 0; i < urls.length; i++) {
                const url = urls[i];
                statusText.innerText = `ä¸‹è¼‰ä¸­... (${i + 1}/${urls.length})`;
                const percentage = Math.round(((i + 1) / urls.length) * 100);
                counterText.innerText = `${percentage}%`;
                progressBar.style.width = `${percentage}%`;

                try {
                    await new Promise(r => setTimeout(r, 50)); 
                    const content = await fetchSegment(url);
                    
                    if (content) {
                        if (i === 0) finalContent += content;
                        else finalContent += cleanVttContent(content);
                        if (i % 5 === 0) log(`âœ… é€²åº¦ [${i+1}/${urls.length}]`);
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (e) {
                    failCount++;
                }
                
                if (i < testLimit && failCount === (i + 1)) {
                    log("â›” åµæ¸¬åˆ°ç€è¦½å™¨è¢«å°é– (403 Forbidden)...", 'error');
                    earlyFailure = true;
                    break;
                }
            }
            
            if (!earlyFailure && successCount > 0 && failCount === 0) {
                saveFile(finalContent);
                log(`âœ¨ ä¸‹è¼‰å®Œæˆï¼(ç„¡éœ€æ•‘æ´)`);
                statusText.innerText = "å®Œæˆ";
                progressBar.classList.replace('bg-blue-500', 'bg-green-500');
                return true;
            } else {
                log("âš ï¸ ç€è¦½å™¨ä¸‹è¼‰å¤±æ•—ï¼Œåˆ‡æ›è‡³æ•‘æ´æ¨¡å¼...", 'warn');
                statusText.innerText = "è«‹ä½¿ç”¨ä¸‹æ–¹æŒ‡ä»¤";
                progressBar.classList.replace('bg-blue-500', 'bg-amber-500');
                return false; 
            }
        }

        async function fetchSegment(url) {
            try {
                const response = await fetch(url, { referrerPolicy: 'no-referrer' });
                if (!response.ok) return null;
                return await response.text();
            } catch (error) {
                return null;
            }
        }

        function generateRescueScript(urls) {
            let fileName = filenameInput.value.trim().replace(/[\\/:*?"<>|]/g, '_');
            if (!fileName) fileName = "video_subtitle";
            if (!fileName.endsWith('.vtt')) fileName += ".vtt";

            const uaVal = uaInput.value.trim();
            const safeUA = uaVal ? uaVal : "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36";

            let script = `# è«‹åœ¨ PowerShell åŸ·è¡Œæ­¤è…³æœ¬ (v5.2)\n`;
            script += `$BaseDir = "$env:USERPROFILE\\Downloads"\n`;
            script += `$FileName = "${fileName}"\n`;
            script += `$BaseName = [System.IO.Path]::GetFileNameWithoutExtension($FileName)\n`;
            script += `$Extension = [System.IO.Path]::GetExtension($FileName)\n`;
            script += `$OutputPath = Join-Path $BaseDir $FileName\n\n`;
            
            script += `# è‡ªå‹•æª¢æŸ¥åŒåæª”æ¡ˆä¸¦ç´¯é€²ç·¨è™Ÿ\n`;
            script += `$Counter = 1\n`;
            script += `while (Test-Path $OutputPath) {\n`;
            script += `    $NewName = "$BaseName ($Counter)$Extension"\n`;
            script += `    $OutputPath = Join-Path $BaseDir $NewName\n`;
            script += `    $Counter++\n`;
            script += `}\n\n`;

            script += `Write-Host "æ­£åœ¨ä¸‹è¼‰å­—å¹•åˆ°: $OutputPath" -ForegroundColor Cyan\n`;
            
            script += `$Headers = @{\n`;
            script += `    "User-Agent" = "${safeUA.replace(/"/g, '`"')}"\n`;
            script += `    "Referer" = "https://player.hotmart.com/"\n`;
            script += `    "Origin" = "https://player.hotmart.com"\n`;
            script += `}\n\n`;

            script += `$TempFile = "$env:TEMP\\temp_vtt_segment.vtt"\n`;
            script += `"" | Out-File -FilePath $OutputPath -Encoding utf8\n\n`; 
            
            script += `$Urls = @(\n`;
            urls.forEach(u => {
                script += `"${u}",\n`;
            });
            script = script.replace(/,\n$/, "\n");
            script += `)\n\n`;
            
            script += `$i = 0\n`;
            script += `foreach ($url in $Urls) {\n`;
            script += `    try {\n`;
            script += `        Invoke-RestMethod -Uri $url -Method Get -Headers $Headers -OutFile $TempFile\n`;
            script += `        $content = Get-Content -Path $TempFile -Encoding UTF8 -Raw\n`;
            
            script += `        if ($i -gt 0) {\n`;
            script += `            $content = $content -replace "^WEBVTT[\r\n]+", ""\n`;
            script += `            $content = $content -replace "^X-TIMESTAMP-MAP.*[\r\n]+", ""\n`;
            script += `            $content = $content.TrimStart()\n`;
            script += `            $content = "\`n" + $content\n`; 
            script += `        }\n`;

            script += `        Add-Content -Path $OutputPath -Value $content -Encoding utf8\n`;
            script += `        Write-Host "." -NoNewline -ForegroundColor Green\n`;
            script += `    } catch {\n`;
            script += `        Write-Host "X" -NoNewline -ForegroundColor Red\n`;
            script += `    }\n`;
            script += `    $i++\n`;
            script += `}\n`;
            
            script += `if (Test-Path $TempFile) { Remove-Item $TempFile }\n`;
            
            script += `\n\nWrite-Host "\nâœ… ä¸‹è¼‰å®Œæˆï¼" -ForegroundColor Green\n`;
            script += `Write-Host "æª”æ¡ˆä½ç½®: $OutputPath" -ForegroundColor Gray\n`;

            rescueScript.value = script;
            rescueContainer.classList.remove('hidden'); 
            setTimeout(() => {
                rescueContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
            
            log("ğŸš¨ å®‰å…¨é˜»æ“‹åµæ¸¬ï¼šå·²ä½¿ç”¨é è¨­ User-Agent ç”Ÿæˆç¹éæŒ‡ä»¤ã€‚", 'warn');
        }

        function copyRescueScript() {
            rescueScript.select();
            document.execCommand('copy');
            alert('æŒ‡ä»¤å·²è¤‡è£½ï¼\n\nè«‹é–‹å•Ÿ PowerShell è²¼ä¸ŠåŸ·è¡Œã€‚');
        }

        function cleanVttContent(rawText) {
            const lines = rawText.split('\n');
            let output = "";
            let headerPassed = false;
            for (let line of lines) {
                if (!headerPassed) {
                    if (line.includes('-->')) {
                        headerPassed = true;
                        output += "\n" + line + "\n"; 
                    }
                } else {
                    output += line + "\n";
                }
            }
            return output;
        }

        function saveFile(content) {
            let fileName = filenameInput.value.trim().replace(/[\\/:*?"<>|]/g, '_');
            if (!fileName) fileName = "video_subtitle";
            if (!fileName.endsWith('.vtt')) fileName += ".vtt";

            const blob = new Blob([content], { type: 'text/vtt;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>